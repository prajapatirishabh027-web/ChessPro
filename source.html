<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chess Master Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <style>
        body { background: #312e2b; color: white; overscroll-behavior: none; -webkit-tap-highlight-color: transparent; }
        #myBoard { width: 95vw; max-width: 450px; margin: auto; }
        .highlight-move { box-shadow: inset 0 0 3px 3px yellow; }
        .history-pane { height: 100px; overflow-y: auto; background: #262421; font-family: monospace; font-size: 11px; }
        .nav-btn { background: #3d3a37; padding: 12px; border-radius: 6px; flex: 1; text-align: center; font-weight: bold; }
        .nav-btn:active { background: #4a4744; }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-2 min-h-screen">
    <div class="mb-2 text-center">
        <h2 id="status" class="text-xs uppercase font-bold text-gray-500">White's Turn</h2>
    </div>
    <div id="myBoard" class="classic shadow-2xl"></div>
    <div class="w-full max-w-[450px] mt-4 space-y-3">
        <div class="flex gap-2">
            <div onclick="moveNav(-1)" class="nav-btn">◀ PREV</div>
            <div onclick="moveNav(1)" class="nav-btn">NEXT ▶</div>
        </div>
        <div id="log" class="history-pane p-2 rounded-lg border border-gray-700 grid grid-cols-2 gap-x-4"></div>
        <div class="bg-[#262421] p-4 rounded-xl space-y-3">
            <button onclick="resetGame()" class="w-full bg-[#81b64c] py-3 rounded font-bold uppercase">New Game</button>
            <div class="flex justify-between items-center text-[10px] text-gray-400">
                <span>CLASSICAL MUSIC</span>
                <button onclick="toggleMusic()" id="mBtn" class="bg-red-900 px-3 py-1 rounded">OFF</button>
            </div>
        </div>
    </div>
    <script>
        let board = null, game = new Chess(), histIdx = -1;
        const stockfish = new Worker('stockfish.js');
        const sfx = { move: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_default/move-self.mp3'), capture: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_default/capture.mp3') };
        const music = new Audio('https://www.bensound.com/bensound-music/bensound-slowmotion.mp3'); music.loop = true;

        function updateUI() {
            const h = game.history(); $('#log').empty();
            h.forEach((m, i) => {
                const step = Math.floor(i/2)+1;
                const txt = (i % 2 === 0 ? step + ". " : "") + m;
                $('#log').append(`<div class="${i === histIdx ? 'text-[#81b64c] font-bold' : ''}">${txt}</div>`);
            });
            $('#log').scrollTop($('#log')[0].scrollHeight);
            $('#status').text(game.turn() === 'w' ? "White's Turn" : "GM thinking...");
        }

        function moveNav(dir) {
            const h = game.history({ verbose: true });
            let next = histIdx + dir;
            if (next >= -1 && next < h.length) {
                histIdx = next;
                board.position(next === -1 ? 'start' : h[next].after);
                updateUI();
            }
        }

        function onDrop(source, target) {
            let m = game.move({ from: source, to: target, promotion: 'q' });
            if (m === null) return 'snapback';
            m.captured ? sfx.capture.play() : sfx.move.play();
            histIdx = game.history().length - 1;
            updateUI();
            if (!game.game_over()) {
                stockfish.postMessage('position fen ' + game.fen());
                stockfish.postMessage('go depth 10');
            }
        }

        stockfish.onmessage = (e) => {
            if (e.data.startsWith('bestmove')) {
                let b = e.data.split(' ')[1];
                let m = game.move({ from: b.slice(0,2), to: b.slice(2,4), promotion: 'q' });
                board.position(game.fen());
                histIdx = game.history().length - 1;
                m.captured ? sfx.capture.play() : sfx.move.play();
                updateUI();
            }
        };

        function toggleMusic() {
            if (music.paused) { music.play(); $('#mBtn').text('ON').css('background','#15803d'); }
            else { music.pause(); $('#mBtn').text('OFF').css('background','#991b1b'); }
        }

        function resetGame() { game.reset(); board.start(); histIdx = -1; updateUI(); }

        board = Chessboard('myBoard', { draggable: true, position: 'start', onDrop: onDrop, 
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png' });
    </script>
</body>
</html>
