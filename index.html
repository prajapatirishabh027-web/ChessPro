<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chess Master Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <style>
        :root { --main-bg: #312e2b; --gold: #d4af37; }
        body { background: var(--main-bg); color: white; overflow-x: hidden; margin: 0; padding: env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0; font-family: sans-serif; }
        .page { display: none; min-height: 100vh; width: 100%; flex-direction: column; align-items: center; padding: 20px 0; }
        .active-page { display: flex; }
        #myBoard { width: 92vw; max-width: 450px; }
        .btn-gold { background: var(--gold); color: black; font-weight: 800; padding: 15px 40px; border-radius: 50px; text-transform: uppercase; }
        .history-log { height: 70px; overflow-y: auto; background: #262421; font-family: monospace; font-size: 11px; border-radius: 8px; }
        .bot-card { background: #3d3a37; padding: 15px; border-radius: 12px; width: 85vw; max-width: 400px; text-align: left; }
        .performance-popup { position: absolute; top: 12%; background: rgba(129, 182, 76, 0.9); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; transform: scale(0); transition: 0.3s; z-index: 100; pointer-events: none; }
        .popup-active { transform: scale(1.2); }
    </style>
</head>
<body>

    <div id="perfMsg" class="performance-popup">Brilliant!!</div>

    <div id="splashPage" class="page active-page flex justify-center items-center">
        <h1 class="text-4xl font-black text-[#81b64c] animate-pulse">CHESS PRO</h1>
    </div>

    <div id="lobbyPage" class="page">
        <img src="https://images.unsplash.com/photo-1529699211952-734e80c4d42b?q=80&w=600" class="w-[85vw] max-w-xs rounded-2xl shadow-2xl mb-8">
        <button onclick="showPage('modePage')" class="btn-gold shadow-lg mb-8">Play Chess</button>
        <div class="w-[90vw] max-w-sm bg-[#262421] p-6 rounded-3xl space-y-4 shadow-xl">
            <div class="flex items-center justify-between">
                <span class="text-sm font-bold uppercase text-gray-400">Ambience</span>
                <button id="mBtn" onclick="toggleMusic()" class="bg-red-900 px-4 py-1 rounded-full text-[10px]">OFF</button>
            </div>
        </div>
    </div>

    <div id="modePage" class="page">
        <h2 class="text-xl font-bold mb-6">Choose Your Mode</h2>
        <div class="space-y-3">
            <div onclick="startGame('human', 'Friend Match')" class="bot-card border-l-4 border-blue-500">
                <p class="font-bold">Human vs Human</p>
                <p class="text-[10px] text-blue-400 font-mono">LOCAL | Play with a Friend</p>
            </div>
            <div onclick="startGame(5, 'Novice Sasha (800)')" class="bot-card border-l-4 border-yellow-500">
                <p class="font-bold">Sasha (Novice AI)</p>
                <p class="text-[10px] text-yellow-500 font-mono">ELO: 800 | Practice Mode</p>
            </div>
            <div onclick="startGame(15, 'GM Boris (2800)')" class="bot-card border-l-4 border-red-600">
                <p class="font-bold text-white">Boris (GM AI)</p>
                <p class="text-[10px] text-red-500 font-mono">ELO: 2800 | Expert Challenge</p>
            </div>
        </div>
        <button onclick="showPage('lobbyPage')" class="mt-8 text-gray-500 font-bold tracking-widest">â—€ HOME</button>
    </div>

    <div id="gamePage" class="page">
        <div id="status" class="text-[10px] font-bold text-[#81b64c] uppercase mb-2">Analyzing Position...</div>
        <div id="myBoard" class="shadow-2xl"></div>
        <div class="w-[92vw] max-w-[450px] mt-4 space-y-4">
            <div id="hist" class="history-log p-3 border border-gray-800 grid grid-cols-2 gap-x-4"></div>
            <button onclick="showPage('lobbyPage')" class="w-full bg-[#3d3a37] py-4 rounded-xl font-bold text-gray-400">Exit Arena</button>
        </div>
    </div>

    <script>
        let board = null, game = new Chess(), histIdx = -1, difficulty = 0;
        const stockfish = new Worker('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js');
        const sfx = { move: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_default/move-self.mp3'), capture: new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_default/capture.mp3') };
        const music = new Audio('https://www.bensound.com/bensound-music/bensound-slowmotion.mp3'); music.loop = true;

        window.onload = () => { setTimeout(() => showPage('lobbyPage'), 1500); registerSW(); };

        function showPage(p) { $('.page').removeClass('active-page'); $('#'+p).addClass('active-page'); }

        function triggerPopup(msg) {
            $('#perfMsg').text(msg).addClass('popup-active');
            setTimeout(() => $('#perfMsg').removeClass('popup-active'), 1200);
        }

        function startGame(level, label) {
            difficulty = level;
            $('#status').text(label);
            game.reset(); board.start(); updateUI(); showPage('gamePage');
        }

        function onDrop(source, target) {
            let m = game.move({ from: source, to: target, promotion: 'q' });
            if (m === null) return 'snapback';
            
            // Intelligence Popup Engine
            if (m.captured) triggerPopup("Nice Catch!");
            else if (['n', 'b'].includes(m.piece)) triggerPopup("Developing Piece!");
            else if (m.san.includes('+')) triggerPopup("Sharp Check!");
            else triggerPopup("Solid Move");

            m.captured ? sfx.capture.play() : sfx.move.play();
            updateUI();

            // Only trigger AI if it's AI mode and game is not over
            if (difficulty !== 'human' && !game.game_over()) {
                $('#status').text("Bot is thinking...");
                stockfish.postMessage('position fen ' + game.fen());
                stockfish.postMessage('go depth ' + difficulty);
            } else if (difficulty === 'human') {
                $('#status').text(game.turn() === 'w' ? "White to Move" : "Black to Move");
            }
        }

        stockfish.onmessage = (e) => {
            if (e.data.startsWith('bestmove')) {
                let m = e.data.split(' ')[1];
                let mv = game.move({ from: m.slice(0,2), to: m.slice(2,4), promotion: 'q' });
                board.position(game.fen());
                mv.captured ? sfx.capture.play() : sfx.move.play();
                updateUI();
                $('#status').text("White to Move");
            }
        };

        function updateUI() {
            const h = game.history(); $('#hist').empty();
            h.forEach((m, i) => $('#hist').append(`<div>${i % 2 === 0 ? Math.floor(i/2)+1 + '. ' : ''}${m}</div>`));
            $('#hist').scrollTop($('#hist')[0].scrollHeight);
        }

        function registerSW() {
            if ('serviceWorker' in navigator) {
                const swCode = `const C='v1';self.addEventListener('install',e=>e.waitUntil(caches.open(C).then(c=>c.addAll(['/','/index.html','/manifest.json']))));self.addEventListener('fetch',e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))));`;
                const blob = new Blob([swCode], {type: 'text/javascript'});
                navigator.serviceWorker.register(URL.createObjectURL(blob));
            }
        }

        function toggleMusic() {
            if (music.paused) { music.play(); $('#mBtn').text('ON').css('background','#15803d'); }
            else { music.pause(); $('#mBtn').text('OFF').css('background','#991b1b'); }
        }

        board = Chessboard('myBoard', { draggable: true, position: 'start', onDrop: onDrop, pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png' });
    </script>
</body>
</html>
